---
title: 什么是事务管理
date: 2025-09-01 17:02:34
tags: SPRING框架
---


# spring中的事务管理

**Spring 中的事务管理**是一个非常核心的知识点，既是开发中经常用到的功能，也是面试高频考点。下面我给你系统讲解。



# 🔹 1. 为什么需要事务管理


事务（Transaction）的四大特性（ACID）：

<!--more-->
- **A** 原子性（Atomicity）：要么全部成功，要么全部失败。
- **C** 一致性（Consistency）：事务前后，数据要保持一致。
- **I** 隔离性（Isolation）：并发事务之间互不干扰。
- **D** 持久性（Durability）：事务一旦提交，数据永久保存。

在业务中，事务非常常见：
比如 **转账**：扣款成功但存款失败，就会造成数据不一致，这时就需要事务来保证“要么都成功，要么都失败”。



# 🔹 2. Spring 事务管理的方式


Spring 提供两种事务管理方式：


### （1）编程式事务管理


👉 通过代码手动控制事务的开启、提交和回滚。


```java
@Transactional
public void transfer() {
    try {
        transactionManager.getTransaction(def);
        accountDao.debit(100);
        accountDao.credit(100);
        transactionManager.commit(status);
    } catch (Exception e) {
        transactionManager.rollback(status);
    }
}

```

这种方式灵活，但会让业务代码和事务代码耦合，实际开发很少用。



### （2）声明式事务管理（常用）


👉 通过 `@Transactional` 注解，让 Spring AOP 自动帮我们管理事务。


```java
@Service
public class AccountService {

    @Transactional
    public void transfer(String from, String to, double money) {
        accountDao.debit(from, money);
        accountDao.credit(to, money);
    }
}

```

Spring 会在方法调用时，自动开启事务，执行成功就提交，异常就回滚。
这就是 **最常用的方式**。



# 🔹 3. @Transactional 的关键属性


常用的属性有：


- **propagation（事务传播行为）**
定义方法在事务中如何传播（如果已经存在事务）：


`REQUIRED`（默认）：如果有事务就加入，没有就新建。


`REQUIRES_NEW`：不管有没有事务，都新建一个事务。


`SUPPORTS`：有事务就加入，没有就不用事务。


`MANDATORY`：必须在事务中，否则报错。


`NOT_SUPPORTED`：不支持事务，挂起当前事务。


`NEVER`：不能在事务中，否则报错。


`NESTED`：嵌套事务，支持部分回滚。
- **isolation（事务隔离级别）**
用于解决并发问题（脏读、不可重复读、幻读）：


`DEFAULT`：数据库默认隔离级别（常见是 READ_COMMITTED）。


`READ_UNCOMMITTED`：可能脏读。


`READ_COMMITTED`：避免脏读（Oracle 默认）。


`REPEATABLE_READ`：避免脏读、不可重复读（MySQL 默认）。


`SERIALIZABLE`：最高隔离级别，避免所有问题，但效率最低。
- **rollbackFor**
指定哪些异常需要回滚（默认只对运行时异常回滚）。
- **timeout**
事务超时时间（秒），超过会自动回滚。


# 🔹 4. Spring 事务实现原理


Spring 事务底层基于 **AOP 动态代理**：


- 在方法执行前：开启事务。
- 方法正常返回：提交事务。
- 方法抛异常：回滚事务。

所以要注意：


- `@Transactional` **必须加在 public 方法上**（因为 JDK 动态代理只代理 public 方法）。
- 不能在同类方法内部调用（事务不会生效，因为代理对象没被用到）。


# 🔹 5. 常见的事务失效场景


1. **@Transactional 加在 private 方法上 → 无效**。
2. **同类内部调用方法 → 无效**（绕过代理）。
3. **异常被捕获且未抛出 → 无法回滚**。
4. **默认只对 RuntimeException 回滚**，受检异常不会回滚（除非 `rollbackFor=Exception.class`）。
5. **数据库不支持事务**（比如 MyISAM 引擎）。


# 🔹 6. 总结


Spring 的事务管理：


- **编程式事务**：自己控制，灵活但繁琐。
- **声明式事务（推荐）**：用 `@Transactional` 注解，简单实用。
- **核心要点**：传播行为（Propagation）、隔离级别（Isolation）、回滚规则。