---
title: swifté—­åŒ…å®ä¾‹è§£æé¢-ä»»åŠ¡é“¾
date: 2025-05-07 11:30:06
tags: [swiftç¼–ç¨‹,é—­åŒ…]
---

# ğŸ’¡ ç”¨é—­åŒ…å®ç°ä¸€ä¸ªâ€œä»»åŠ¡é“¾â€


### ğŸ’» åŸå§‹ä»£ç ï¼š


```swift
func makeTaskQueue() -> () -> Void {
    var tasks: [() -> Void] = []
    
    func addTask(_ task: @escaping () -> Void) {
        tasks.append(task)
    }
    
    func run() {
        tasks.forEach { $0() }
    }
    
    return {
        addTask { print("Task 1") }
        addTask { print("Task 2") }
        run()
    }
}

let runAll = makeTaskQueue()
runAll()
```
<!--more-->


## ğŸ§  æœ¬è´¨ç›®æ ‡ï¼š


æ„é€ ä¸€ä¸ª**ä»»åŠ¡è°ƒåº¦å™¨**ï¼š
ä½ æŠŠå¤šä¸ªä»»åŠ¡ï¼ˆç”¨é—­åŒ…è¡¨ç¤ºï¼‰ä¸€ä¸ªä¸ªâ€œæ”¶é›†â€èµ·æ¥ï¼Œæœ€åç»Ÿä¸€æ‰§è¡Œã€‚



## ğŸ§± åˆ†æ­¥è§£é‡Šï¼š


### âœ… 1. å‡½æ•°ç­¾å


```swift
func makeTaskQueue() -> () -> Void
```


è¿™æ˜¯ä¸€ä¸ª**é«˜é˜¶å‡½æ•°**ï¼Œè¿”å›ä¸€ä¸ªé—­åŒ… `() -> Void`ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨ `makeTaskQueue()` ä¼šè¿”å›ä¸€ä¸ªä¸å¸¦å‚æ•°ã€ä¸è¿”å›å€¼çš„å‡½æ•°ã€‚



### âœ… 2. å†…éƒ¨çš„ tasks æ•°ç»„


```swift
var tasks: [() -> Void] = []
```


æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„ `tasks`ï¼Œç”¨äºå­˜å‚¨é—­åŒ…ï¼ˆä»»åŠ¡ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ `() -> Void`ï¼Œè¡¨ç¤ºï¼šæ— å‚æ•°ã€æ— è¿”å›å€¼çš„å‡½æ•°ã€‚



### âœ… 3. å†…éƒ¨çš„ addTask å‡½æ•°


```swift
func addTask(_ task: @escaping () -> Void) {
    tasks.append(task)
}
```


è¿™ä¸ªå‡½æ•°å°†é—­åŒ… `task` æ·»åŠ è¿› `tasks` æ•°ç»„ã€‚


- `@escaping` å…³é”®å­—æ˜¯å¿…é¡»çš„ï¼šå› ä¸ºé—­åŒ…è¢«â€œé€ƒé€¸â€åˆ°å¤–éƒ¨ `tasks` æ•°ç»„ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸæ¯”å½“å‰å‡½æ•°é•¿ã€‚


### âœ… 4. run å‡½æ•°ï¼šç”¨äºç»Ÿä¸€æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡


```swift
func run() {
    tasks.forEach { $0() }
}
```


ç”¨ `forEach` éå† `tasks`ï¼Œå¹¶æ‰§è¡Œæ¯ä¸ªé—­åŒ…ï¼ˆä»»åŠ¡ï¼‰ã€‚



### âœ… 5. è¿”å›çš„é—­åŒ…ï¼š


```swift
return {
    addTask { print("Task 1") }
    addTask { print("Task 2") }
    run()
}
```


è¿™ä¸ªé—­åŒ…å®šä¹‰äº† **ä½ â€œæœ€ç»ˆè°ƒç”¨è¿”å›å€¼æ—¶â€åšçš„äº‹æƒ…**ï¼Œå®ƒï¼š


1. æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼›
2. ç„¶åæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚


### âœ… 6. ä½¿ç”¨æ–¹å¼


```swift
let runAll = makeTaskQueue()
runAll()
```


è§£é‡Šï¼š


- `makeTaskQueue()` è¿”å›äº†ä¸€ä¸ªé—­åŒ…ã€‚
- `runAll()` å°±æ˜¯è¿è¡Œè¿™ä¸ªé—­åŒ…ï¼šå®ƒä¼šæ‰§è¡Œåˆšæ‰æˆ‘ä»¬åœ¨é—­åŒ…ä¸­å®šä¹‰çš„é€»è¾‘ï¼Œå³æ·»åŠ ä»»åŠ¡ + æ‰§è¡Œä»»åŠ¡ã€‚


## ğŸ§ª è¾“å‡ºç»“æœï¼š


```arduino
Task 1
Task 2
```


è¯´æ˜ä»»åŠ¡ç¡®å®è¢«ä¾æ¬¡æ‰§è¡Œäº†ã€‚



## ğŸ“Œ å…³é”®çŸ¥è¯†ç‚¹æ€»ç»“ï¼š


| çŸ¥è¯†ç‚¹ | è§£é‡Š |
| ---- | ---- |
| é—­åŒ…æ•°ç»„ [() -> Void] | ç”¨äºä¿å­˜å¤šä¸ªå¯æ‰§è¡Œä»»åŠ¡ |
| @escaping | é—­åŒ…é€ƒé€¸åˆ°å½“å‰å‡½æ•°ä½œç”¨åŸŸå¤–ï¼ˆä¾‹å¦‚å­˜å…¥æ•°ç»„ï¼‰æ—¶éœ€è¦ |
| é«˜é˜¶å‡½æ•°è¿”å›å€¼ | makeTaskQueue è¿”å›çš„æ˜¯ä¸€ä¸ªé—­åŒ… |
| é—­åŒ…æ•è·ä¸Šä¸‹æ–‡ | tasksã€addTaskã€run éƒ½è¢«â€œæ•è·â€åˆ°è¿”å›é—­åŒ…ä¸­ |
| å‡½æ•°å¼ç¼–ç¨‹æ€æƒ³ | æ„å»ºå‡½æ•°ç»„åˆç»“æ„ï¼Œå»¶è¿Ÿæ‰§è¡Œé€»è¾‘ |



## ğŸ”§ æ‹“å±•ç»ƒä¹ å»ºè®®


ä½ å¯ä»¥å°è¯•å¯¹è¿™ä¸ªä»»åŠ¡ç³»ç»Ÿåšä¸€äº›å‡çº§ï¼š


1. **æ”¹æˆç±»ï¼Œæ”¯æŒå¤–éƒ¨åŠ¨æ€æ·»åŠ ä»»åŠ¡ï¼š**

```swift
class TaskQueue {
    private var tasks: [() -> Void] = []

    func add(_ task: @escaping () -> Void) {
        tasks.append(task)
    }

    func run() {
        tasks.forEach { $0() }
    }
}
```
2. **åŠ ä»»åŠ¡å‘½å + æ—¥å¿—è®°å½•åŠŸèƒ½**
3. **åŠ å»¶è¿Ÿæ‰§è¡ŒåŠŸèƒ½ï¼ˆDispatchQueueï¼‰**
4. **æ¨¡æ‹Ÿå¹¶å‘ä»»åŠ¡æ‰§è¡Œ**



# é—®é¢˜
() -> Void å‡½æ•°è¿”å›ç±»å‹å’ŒçœŸæ­£çš„return {
    addTask { print("Task 1") }
    addTask { print("Task 2") }
    run()
}åŒ¹é…å—ï¼Ÿæ„Ÿè§‰è¿”å›çš„ä¸æ˜¯() -> Void ç±»å‹




## ğŸ¤” ç–‘é—®é‡è¿°ï¼š


ä½ çœ‹åˆ°ä»£ç ï¼š


```swift
func makeTaskQueue() -> () -> Void {
    ...
    return {
        addTask { print("Task 1") }
        addTask { print("Task 2") }
        run()
    }
}
```


ä½ ç–‘æƒ‘ï¼š


- `makeTaskQueue` å£°æ˜è¿”å› `() -> Void` ç±»å‹ï¼›
- ä½† `return { ... }` é‡Œçœ‹èµ·æ¥æ‰§è¡Œäº†å¾ˆå¤šäº‹æƒ…ï¼Œè¿˜è°ƒç”¨äº† `run()`ï¼›
- ä¸ºä»€ä¹ˆè¿™ä»ç„¶ç®—æ˜¯ `() -> Void` ç±»å‹ï¼Ÿ


## âœ… è§£ç­”ï¼š**è¿”å›å€¼æ˜¯ä¸€ä¸ªâ€œé—­åŒ…â€ï¼Œè€Œéé—­åŒ…æ‰§è¡Œçš„ç»“æœ**


å…³é”®ç‚¹æ˜¯ï¼š


```swift
return {
    addTask { print("Task 1") }
    addTask { print("Task 2") }
    run()
}
```


è¿™ä¸ªè¯­æ³•æ˜¯ï¼š**è¿”å›ä¸€ä¸ªé—­åŒ…æœ¬èº«**ï¼ˆè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œé—­åŒ…åè¿”å›ç»“æœï¼‰ã€‚



### âœ… é—­åŒ…çš„è¯­æ³•ç³–ï¼š


Swift ä¸­ `return { ... }` çš„ `{}` éƒ¨åˆ†å°±æ˜¯ä¸€ä¸ª**é—­åŒ…è¡¨è¾¾å¼**ï¼Œæœ¬è´¨ä¸Šç­‰ä»·äºï¼š


```swift
let closure: () -> Void = {
    addTask { print("Task 1") }
    addTask { print("Task 2") }
    run()
}
return closure
```


è¿™é‡Œé—­åŒ…ç±»å‹ç¡®å®æ˜¯ `() -> Void`ï¼Œå› ä¸ºï¼š


- å®ƒä¸æ¥å—ä»»ä½•å‚æ•°ï¼›
- æœ€åæ‰§è¡Œçš„æ˜¯ `run()`ï¼Œè€Œ `run()` æœ¬èº«è¿”å› `Void`ï¼›
- æ‰€ä»¥è¿™ä¸ªé—­åŒ…â€œæ•´ä½“â€çš„è¿”å›å€¼æ˜¯ `Void`ï¼Œå³ç¬¦åˆ `() -> Void` ç±»å‹ã€‚


## ğŸ” å…³é”®ç‚¹æ€»ç»“


| é¡¹ | è¯´æ˜ |
| ---- | ---- |
| () -> Void | æ˜¯**å‡½æ•°/é—­åŒ…ç±»å‹**ï¼Œè¡¨ç¤ºâ€œæ¥å—0ä¸ªå‚æ•°ã€è¿”å›Voidçš„å‡½æ•°â€ |
| return { ... } | è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œè€Œéæ‰§è¡Œç»“æœ |
| { addTask...; run() } | æ˜¯é—­åŒ…çš„å†…å®¹ï¼Œåªæœ‰è°ƒç”¨é—­åŒ…æ—¶æ‰ä¼šæ‰§è¡Œè¿™äº›è¯­å¥ |
| Void å’Œ () | åœ¨ Swift ä¸­æ˜¯ä¸€æ ·çš„ï¼Œè¡¨ç¤ºâ€œæ²¡æœ‰è¿”å›å€¼â€ |



## âœ… ç¤ºä¾‹éªŒè¯


ä½ å¯ä»¥åœ¨ Playground ä¸­è¯•è¯•è¿™ä¸ªç®€å•ä¾‹å­æ¥åŠ æ·±ç†è§£ï¼š


```swift
func makeThing() -> () -> Void {
    return {
        print("This is a closure.")
    }
}

let closure = makeThing() // è¿”å›çš„æ˜¯é—­åŒ…æœ¬èº«
closure()                 // ç°åœ¨æ‰æ‰§è¡Œé—­åŒ…ï¼Œæ‰“å°ä¿¡æ¯
```



## ğŸš« æ˜“æ··æ·†ç‚¹ï¼šä¸æ˜¯â€œæ‰§è¡Œåè¿”å›ç»“æœâ€


å¾ˆå¤šäººä¼šä»¥ä¸ºï¼š


```swift
return {
    doSomething()
}
```


å¥½åƒæ˜¯ â€œè¿”å› `doSomething()` çš„æ‰§è¡Œç»“æœâ€ï¼Œä½†å®é™…ä¸Šæ˜¯è¿”å› â€œä¸€ä¸ªåŒ…ç€ `doSomething()` çš„é—­åŒ…â€ã€‚



## âœ… æ€»ç»“ä¸€å¥è¯ï¼š



`return { ... }` è¿”å›çš„æ˜¯é—­åŒ…æœ¬èº«ï¼Œä¸æ˜¯é—­åŒ…æ‰§è¡Œåçš„ç»“æœã€‚åªè¦é—­åŒ…ç­¾åæ˜¯ `() -> Void`ï¼Œæ— è®ºé‡Œé¢æ‰§è¡Œå¤šå°‘è¯­å¥ã€è°ƒç”¨å¤šå°‘å‡½æ•°ï¼Œå®ƒçš„**æ•´ä½“ç±»å‹**å°±æ˜¯ `() -> Void` â€”â€” è·Ÿä½ çœ‹åˆ°çš„åŒ¹é…å®Œå…¨ä¸€è‡´ã€‚




æ˜¯å¦è¿˜æƒ³è¿›ä¸€æ­¥æ¢è®¨é—­åŒ…ä¸­çš„â€œæ•è·ç¯å¢ƒå˜é‡â€ã€â€œé€ƒé€¸é—­åŒ…â€å’Œâ€œå°¾éšé—­åŒ…â€è¿™äº›é«˜çº§ç”¨æ³•ï¼Ÿæˆ‘å¯ä»¥ç»§ç»­æ‰©å±•ã€‚
# é—®é¢˜
è¯¦ç»†è§£é‡Šä¸‹è¿™ä¸ªå‡½æ•°ï¼Œ  func addTask(_ task: @escaping () ->Void) {
        tasks.append(task)
    }ä»¥åŠfunc makeTaskQueue() ->() ->Voidå‡½æ•°æ‰§è¡Œçš„åº•å±‚ç»†èŠ‚
# ChatGPT
éå¸¸å¥½ï¼Œè¿™æ˜¯æ·±å…¥ç†è§£ Swift é—­åŒ…å’Œå‡½æ•°è¡Œä¸ºçš„å…³é”®ä¸€æ­¥ï¼æˆ‘ä»¬æ¥ä»**è¯­ä¹‰ã€åº•å±‚å®ç°ã€æ•è·è¡Œä¸º**å¤šä¸ªè§’åº¦è¯¦ç»†è§£æä¸‹é¢è¿™ä¸¤æ®µä»£ç ï¼š



## ğŸ”¹å‡½æ•° 1ï¼šaddTask(_:)


```swift
func addTask(_ task: @escaping () -> Void) {
    tasks.append(task)
}
```


### âœ… è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆï¼Ÿ


- æ¥æ”¶ä¸€ä¸ªé—­åŒ…å‚æ•° `task`ï¼Œç±»å‹æ˜¯ `() -> Void`ï¼ˆæ— å‚æ•°æ— è¿”å›å€¼ï¼‰
- æŠŠè¿™ä¸ªé—­åŒ…è¿½åŠ è¿› `tasks` è¿™ä¸ªæ•°ç»„


### â—ï¸ä¸ºä»€ä¹ˆè¦ç”¨ @escapingï¼Ÿ


Swift é»˜è®¤å‡½æ•°å‚æ•°ä¸­çš„é—­åŒ…æ˜¯â€œéé€ƒé€¸çš„â€ï¼ˆnon-escapingï¼‰ï¼Œæ„å‘³ç€é—­åŒ…ä¼šåœ¨å‡½æ•°è°ƒç”¨æœŸé—´å°±æ‰§è¡Œå®Œï¼Œä¸ä¼šåœ¨å‡½æ•°ä½“ä¹‹å¤–ä¿å­˜èµ·æ¥ã€‚


**ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å°† task å­˜è¿›äº† tasks æ•°ç»„ï¼Œæ‰“ç®—ç¨åæ‰§è¡Œ** â€”â€” è¿™å°±æ˜¯â€œé—­åŒ…é€ƒé€¸â€ã€‚


ğŸ§  **é€ƒé€¸é—­åŒ…çš„å®šä¹‰ï¼š**



è¢«ä¼ å…¥å‡½æ•°å†…éƒ¨ï¼Œä½†å‡½æ•°ç»“æŸåä»ä¼šè¢«ä½¿ç”¨æˆ–æŒæœ‰çš„é—­åŒ…ï¼Œç§°ä¸ºâ€œé€ƒé€¸é—­åŒ…â€ï¼Œå¿…é¡»ç”¨ `@escaping` æ ‡è®°ã€‚




### ğŸ”¬ ç¼–è¯‘å™¨å¦‚ä½•å¤„ç† @escapingï¼Ÿ


å½“ä½ åŠ äº† `@escaping`ï¼ŒSwift ç¼–è¯‘å™¨ä¼šå°†é—­åŒ…æå‡åˆ°å †ï¼ˆheapï¼‰ä¸Šè¿›è¡ŒæŒä¹…åŒ–ï¼Œä¿è¯å‡½æ•°æ‰§è¡Œå®Œä¹‹åé—­åŒ…è¿˜èƒ½ç»§ç»­å­˜åœ¨ã€‚å¦åˆ™ï¼Œå®ƒå¯èƒ½ä¼šå› ä¸ºè¢«æ”¾åœ¨æ ˆä¸Šè€Œå¤±æ•ˆï¼ˆdangling pointerï¼‰ã€‚



## ğŸ”¹å‡½æ•° 2ï¼šmakeTaskQueue() -> () -> Void


### ğŸ‘€ é¦–å…ˆçœ‹è¿”å›ç±»å‹ï¼š


```swift
() -> Void
```


æ„å‘³ç€ `makeTaskQueue()` è¿”å›ä¸€ä¸ª**å‡½æ•°/é—­åŒ…**ï¼Œè¿™ä¸ªè¿”å›å€¼æ²¡æœ‰å‚æ•°ã€è¿”å› `Void`ï¼ˆå³æ²¡æœ‰è¿”å›å€¼ï¼‰ã€‚



### ğŸ“¦ å‡½æ•°ä½“ï¼š


```swift
func makeTaskQueue() -> () -> Void {
    var tasks: [() -> Void] = []

    func addTask(_ task: @escaping () -> Void) {
        tasks.append(task)
    }

    func run() {
        tasks.forEach { $0() }
    }

    return {
        addTask { print("Task 1") }
        addTask { print("Task 2") }
        run()
    }
}
```


### ğŸ” æ‰§è¡Œç»†èŠ‚ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š


1. **å‡½æ•°è¢«è°ƒç”¨**ï¼š

```swift
let f = makeTaskQueue()
```
2. **å†…éƒ¨ä½œç”¨åŸŸæ„å»ºï¼š**

- åˆ›å»ºäº†ä¸€ä¸ªå±€éƒ¨æ•°ç»„ `tasks`ï¼ˆæ ˆä¸Šçš„å¼•ç”¨ï¼Œä½†å®é™…å…ƒç´ åœ¨å †ä¸Šï¼‰ï¼›
- å®šä¹‰äº†ä¸¤ä¸ªå†…éƒ¨å‡½æ•° `addTask()` å’Œ `run()`ï¼Œå®ƒä»¬éƒ½é—­åŒ…æ•è·äº† `tasks`ï¼›
3. **è¿”å›ä¸€ä¸ªé—­åŒ… { ... }**ï¼š

- è¿™ä¸ªé—­åŒ… **å†…éƒ¨è°ƒç”¨ addTask() å¤šæ¬¡å¹¶æ‰§è¡Œ run()**ï¼›
- å®ƒè¢«è¿”å›ç»™å¤–éƒ¨ï¼š`f` æ­¤æ—¶å°±æ˜¯è¿™ä¸ªé—­åŒ…ã€‚


### ğŸ§  é—­åŒ…æ•è·å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ


è¿”å›çš„é—­åŒ…ä¸­ä½¿ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ `tasks`ã€å‡½æ•° `addTask()` å’Œ `run()`ï¼Œæ‰€ä»¥ Swift ä¼šï¼š


- å°†è¿™äº›**æ•è·å˜é‡å¤åˆ¶å¹¶å°è£…è¿›é—­åŒ…ä¸Šä¸‹æ–‡å¯¹è±¡**ï¼›
- æ‰€ä»¥å³ä½¿å‡½æ•° `makeTaskQueue()` å·²ç»è¿”å›ï¼Œ`tasks` æ•°ç»„ä»ç„¶å­˜åœ¨äºå†…å­˜ä¸­ï¼ˆå †ï¼‰ï¼›
- è¿™æ˜¯ Swift çš„é—­åŒ…æ•è·æ¨¡å‹ï¼š**é€šè¿‡éšå¼åˆ›å»ºä¸Šä¸‹æ–‡ç»“æ„ä½“ï¼ˆContext Structï¼‰ä¿å­˜æ‰€æœ‰å¼•ç”¨ã€‚**


### ğŸ“¦ å†…å­˜æ¨¡å‹ï¼ˆç¤ºæ„ï¼‰ï¼š


```swift
let closure = makeTaskQueue()
// ç›¸å½“äºç”Ÿæˆäº†ä¸€ä¸ªç»“æ„ä½“ï¼ˆç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼‰ï¼š
struct TaskQueueContext {
    var tasks: [() -> Void]
    func addTask(...) { ... }
    func run() { ... }
    func call() {
        addTask { print("Task 1") }
        addTask { print("Task 2") }
        run()
    }
}
```


è¿”å›çš„é—­åŒ…å…¶å®æ˜¯å°è£…äº†è¿™ä¸ª `call()` æ–¹æ³•çš„ç»“æ„ä½“å®ä¾‹ï¼Œé—­åŒ…è¿è¡Œæ—¶å®é™…ä¸Šåœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚



## âœ… æ•´ä½“æµç¨‹å›é¡¾ï¼š


| æ­¥éª¤ | æè¿° |
| ---- | ---- |
| 1 | è°ƒç”¨ makeTaskQueue() |
| 2 | åˆ›å»º tasks æ•°ç»„ï¼Œå®šä¹‰ addTask() å’Œ run() |
| 3 | è¿”å›ä¸€ä¸ªé—­åŒ… { addTask...; run() }ï¼Œæ•è·äº†è¿™äº›ä¸Šä¸‹æ–‡ |
| 4 | å½“ä½ è°ƒç”¨é—­åŒ…æ—¶ï¼Œå®ƒä¼šé¡ºåºæ·»åŠ ä»»åŠ¡å¹¶è¿è¡Œä»»åŠ¡ |



## ğŸ§ª è°ƒè¯•å»ºè®®ï¼ˆåœ¨ Playground å®éªŒï¼‰


```swift
let closure = makeTaskQueue()
print(type(of: closure)) // çœ‹é—­åŒ…ç±»å‹
closure() // å®é™…è¿è¡Œä»»åŠ¡
```


ä½ ç”šè‡³å¯ä»¥æ‰“å°é—­åŒ…çš„åœ°å€ã€ä»»åŠ¡æ•°é‡ç­‰ä¿¡æ¯æ¥è¿›ä¸€æ­¥ç†è§£æ•è·ä½œç”¨ã€‚



## âœ³ï¸ Bonusï¼šå¯è§†åŒ–â€œæ•è·â€åŸç†å›¾


```go
+------------------------+
| makeTaskQueue()        |
|                        |
|  +------------------+  |
|  | var tasks: [...] |â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
|  +------------------+  |          â”‚
|  | func addTask()   |â”€â”€â”          â”‚
|  | func run()       |â”€â”€â”˜          â”‚
|  +------------------+             â”‚
|        â†“ captured                 â”‚
|  return { ... addTask(); run() } â”‚
|        â†‘ returned closure â”€â”€â”€â”€â”€â”€â”€â”˜
+------------------------+
```



## âœ… æ€»ç»“


- `addTask()` æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œæ¥å—é€ƒé€¸é—­åŒ…ï¼Œä¿å­˜åˆ° `tasks` æ•°ç»„ã€‚
- `makeTaskQueue()` è¿”å›ä¸€ä¸ªæ•è·äº†å†…éƒ¨çŠ¶æ€çš„é—­åŒ…ï¼Œå®ç°å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ã€‚
- Swift åº•å±‚ç”¨ç»“æ„ä½“å°è£…æ•è·ç¯å¢ƒï¼Œé—­åŒ…æŒæœ‰è¿™äº›çŠ¶æ€ï¼Œå“ªæ€•å¤–éƒ¨å‡½æ•°å·²ç»ç»“æŸã€‚


# æ·±å…¥å­¦ä¹  Swift ä¸­çš„**é€ƒé€¸é—­åŒ…ã€è‡ªåŠ¨é—­åŒ…ï¼ˆ@autoclosureï¼‰æˆ–æ•è·åˆ—è¡¨**ç­‰è¿›é˜¶é—­åŒ…æŠ€å·§ï¼Ÿ




### âœ… 1. **é€ƒé€¸é—­åŒ…ï¼ˆ@escapingï¼‰**


- é—­åŒ…åœ¨å‡½æ•°ä½œç”¨åŸŸç»“æŸåè¿˜å¯èƒ½è¢«è°ƒç”¨ã€‚
- å¸¸ç”¨äºå¼‚æ­¥æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€å»¶æ—¶å›è°ƒï¼‰ã€‚
- ç¤ºä¾‹è®²è§£ + ä»»åŠ¡é˜Ÿåˆ—æ¨¡æ‹Ÿã€‚


### âœ… 2. **è‡ªåŠ¨é—­åŒ…ï¼ˆ@autoclosureï¼‰**


- è®©å‡½æ•°å‚æ•°æ”¯æŒâ€œå»¶è¿Ÿæ‰§è¡Œâ€ã€‚
- è¯­æ³•æ›´ç®€æ´ï¼Œå¸¸ç”¨äº `assert()`, `guard`, `fatalError()` ç­‰ã€‚

```swift
func log(_ message: @autoclosure () -> String) {
    print("Log: \(message())")
}
log("Something went wrong!") // è‡ªåŠ¨å˜æˆé—­åŒ…
```



### âœ… 3. **æ•è·åˆ—è¡¨ï¼ˆ[weak self], [unowned self]ï¼‰**


- è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ç±»ä¸é—­åŒ…äº’ç›¸å¼•ç”¨çš„æƒ…å†µä¸‹ã€‚
- ç”¨äºé˜²æ­¢å†…å­˜æ³„æ¼ã€‚

```swift
class MyClass {
    var name = "Swift"
    func run() {
        DispatchQueue.main.async { [weak self] in
            print(self?.name ?? "nil")
        }
    }
}
```



### âœ… 4. **é—­åŒ…ä¸å†…å­˜ç®¡ç†**


- ARC å¦‚ä½•ç®¡ç†é—­åŒ…æ•è·çš„å¼•ç”¨ï¼Ÿ
- å¦‚ä½•ç†è§£â€œæ•è·çš„å€¼â€ vs â€œæ•è·çš„å¼•ç”¨â€ï¼Ÿ
- å † vs æ ˆè¡Œä¸ºæ·±å…¥ã€‚





## ğŸ§  ä»€ä¹ˆæ˜¯æ•è·åˆ—è¡¨ï¼ˆCapture Listï¼‰ï¼Ÿ


å½“ä½ åœ¨ä¸€ä¸ªé—­åŒ…ä¸­ä½¿ç”¨äº†å¤–éƒ¨å˜é‡æ—¶ï¼Œ**Swift é»˜è®¤ä¼šâ€œå¼ºå¼•ç”¨â€å®ƒä»¬**ï¼ˆå°¤å…¶æ˜¯ç±»å®ä¾‹ï¼‰ã€‚
è¿™å¯èƒ½å¯¼è‡´**å¾ªç¯å¼•ç”¨ï¼ˆretain cycleï¼‰**ï¼Œä»è€Œå¼•å‘**å†…å­˜æ³„æ¼**ã€‚


â¡ï¸ æ•è·åˆ—è¡¨å…è®¸ä½ æ§åˆ¶è¿™äº›å¤–éƒ¨å¼•ç”¨æ˜¯å¼ºå¼•ç”¨ã€å¼±å¼•ç”¨ï¼Œè¿˜æ˜¯æ— ä¸»å¼•ç”¨ã€‚



## ğŸ” åŸºæœ¬è¯­æ³•


```swift
let closure = { [capture1, capture2] in
    // ä»£ç 
}
```


ä½†æœ€å¸¸è§çš„å†™æ³•æ˜¯ç”¨äºå¼•ç”¨ `self`ï¼š


```swift
someAsyncTask { [weak self] in
    self?.doSomething()
}
```



## ğŸ“Œ ä¸¾ä¾‹è¯´æ˜ï¼ˆé»˜è®¤å¼ºå¼•ç”¨ï¼‰


```swift
class MyClass {
    var name = "Swift"
    lazy var printName: () -> Void = {
        print("Name is \(self.name)")
    }
}

let obj = MyClass()
obj.printName()  // è¾“å‡º "Name is Swift"
```


### â›”é—®é¢˜ï¼šå¾ªç¯å¼•ç”¨


- `obj` å¼ºå¼•ç”¨ `printName` é—­åŒ…ï¼›
- é—­åŒ…åˆå¼ºå¼•ç”¨ `self`ï¼ˆå³ objï¼‰ï¼›
- å¯¼è‡´ `obj` æ°¸è¿œä¸ä¼šé‡Šæ”¾ â†’ å†…å­˜æ³„æ¼ã€‚


## âœ… æ•è·åˆ—è¡¨è§£å†³æ–¹æ³•


### 1. **[weak self]**ï¼ˆå¯é€‰å¼•ç”¨ï¼‰


```swift
lazy var printName: () -> Void = { [weak self] in
    print("Name is \(self?.name ?? "nil")")
}
```


- `self` å˜æˆå¯é€‰ç±»å‹ï¼›
- ä¸å†é€ æˆå¼ºå¼•ç”¨ï¼›
- å¦‚æœ `self` è¢«é‡Šæ”¾ï¼Œé—­åŒ…ä¹Ÿä¸ä¼šé˜»æ­¢ã€‚


### 2. **[unowned self]**ï¼ˆéå¯é€‰å¼•ç”¨ï¼‰


```swift
lazy var printName: () -> Void = { [unowned self] in
    print("Name is \(self.name)")
}
```


- æ›´åƒâ€œå¼±å¼•ç”¨ä½†ä¸æ£€æŸ¥æ˜¯å¦ä¸ºç©ºâ€ï¼›
- âš ï¸å¦‚æœ `self` å·²é‡Šæ”¾ï¼Œè®¿é—®å°†å¯¼è‡´ **è¿è¡Œæ—¶å´©æºƒ**ï¼›
- é€‚åˆä½ ç¡®å®šé—­åŒ…æ‰§è¡ŒæœŸé—´ `self` ä¸ä¼šé‡Šæ”¾çš„åœºæ™¯ã€‚


## âœ… æ•è·å¸¸é‡ vs å˜é‡


```swift
var x = 10
let closure = { [x] in
    print(x)
}
x = 20
closure()  // è¾“å‡º 10ï¼Œå› ä¸ºæ•è·äº†å½“æ—¶çš„ x å€¼å‰¯æœ¬
```


- æ•è·çš„æ˜¯**å€¼**ï¼Œä¸æ˜¯å˜é‡æœ¬èº«ï¼›
- æ‰€ä»¥ä¹‹åå¤–éƒ¨å˜é‡æ”¹å˜ï¼Œé—­åŒ…ä¸­çš„å€¼ä¸ä¼šå˜ã€‚


## ğŸ”§ å®æˆ˜ç»ƒä¹ ï¼šé¿å…å¾ªç¯å¼•ç”¨


```swift
class ViewModel {
    var name = "User"
    
    func load() {
        simulateAsync { [weak self] in
            guard let self = self else { return }
            print("Loaded \(self.name)")
        }
    }
    
    func simulateAsync(_ completion: @escaping () -> Void) {
        DispatchQueue.global().asyncAfter(deadline: .now() + 1) {
            completion()
        }
    }
}
```



## ğŸ“Œ æ€»ç»“å¯¹æ¯”è¡¨


| å†™æ³• | æ˜¯å¦é‡Šæ”¾ self | æ˜¯å¦å¯é€‰ | å´©æºƒé£é™© | é€‚ç”¨åœºæ™¯ |
| ---- | ---- | ---- | ---- | ---- |
| [strong self] | âŒ å¦ï¼ˆé»˜è®¤ï¼‰ | å¦ | âŒ | é»˜è®¤ï¼Œå¯èƒ½å¾ªç¯å¼•ç”¨ |
| [weak self] | âœ… æ˜¯ | âœ… æ˜¯ | âŒ | ä¸ç¡®å®šæ˜¯å¦é‡Šæ”¾ |
| [unowned self] | âœ… æ˜¯ | âŒ å¦ | âœ… æœ‰å´©æºƒé£é™© | self ä¿è¯ç”Ÿå‘½å‘¨æœŸå­˜åœ¨ |



## âœ… æ¨èç»ƒä¹ ï¼ˆå¯å¤åˆ¶è¿› Playgroundï¼‰


```swift
class TimerHandler {
    var count = 0

    func start() {
        Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { [weak self] _ in
            self?.count += 1
            print("Count: \(self?.count ?? -1)")
        }
    }
}

var handler: TimerHandler? = TimerHandler()
handler?.start()
DispatchQueue.main.asyncAfter(deadline: .now() + 5) {
    handler = nil // è§‚å¯Ÿæ˜¯å¦å†…å­˜æ³„éœ²
}
```
